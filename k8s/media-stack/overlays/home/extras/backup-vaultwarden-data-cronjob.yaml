apiVersion: batch/v1
kind: CronJob
metadata:
  name: backup-vaultwarden-data
  namespace: media
spec:
  schedule: "45 * * * 0"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      template:
        metadata:
          labels:
            app: backup-vaultwarden-data
        spec:
          restartPolicy: OnFailure

          # Force the backup pod to run on the same node as the vaultwarden pod
          affinity:
            podAffinity:
              preferredDuringSchedulingIgnoredDuringExecution:
                - weight: 100
                  podAffinityTerm:
                    labelSelector:
                      matchLabels:
                        app: vaultwarden
                    topologyKey: kubernetes.io/hostname

          containers:
            - name: backup
              image: alpine:3.20
              imagePullPolicy: IfNotPresent
              command:
                - /bin/sh
                - -ceu
                - |
                  apk add --no-cache rsync >/dev/null
                  ts="$(date +%F-%H%M%S)"
                  root="/backup/backups/vaultwarden-data"
                  dest="${root}/${ts}"
                  mkdir -p "${dest}"
                  rsync -a --delete \
                    --include='rsa*' \
                    --include='db.sqlite3' \
                    --include='db.sqlite3-wal' \
                    --include='db.sqlite3-shm' \
                    --include='attachments/***' \
                    --exclude='*' \
                    /data/ "${dest}/"
                  ln -sfn "${ts}" "${root}/latest"
                  find "${root}" -mindepth 1 -maxdepth 1 -type d -mtime +14 -exec rm -rf {} \;
              volumeMounts:
                - name: source
                  mountPath: /data
                  readOnly: true
                - name: backup
                  mountPath: /backup
          volumes:
            - name: source
              persistentVolumeClaim:
                claimName: vaultwarden-data
            - name: backup
              persistentVolumeClaim:
                claimName: nfs-export-root
