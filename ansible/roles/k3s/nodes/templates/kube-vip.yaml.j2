apiVersion: v1
kind: ServiceAccount
metadata:
  name: kube-vip
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: kube-vip-role
rules:
  - apiGroups: [""]
    resources: ["services","endpoints","nodes","pods"]
    verbs: ["get","list","watch","update","patch"]
  - apiGroups: ["coordination.k8s.io"]
    resources: ["leases"]
    verbs: ["get","list","watch","create","update","patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kube-vip-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: kube-vip-role
subjects:
  - kind: ServiceAccount
    name: kube-vip
    namespace: kube-system
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: kube-vip
  namespace: kube-system
spec:
  selector:
    matchLabels:
      app: kube-vip
  template:
    metadata:
      labels:
        app: kube-vip
    spec:
      serviceAccountName: kube-vip
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      containers:
        - name: kube-vip
          image: "{{ kubevip_image | default('ghcr.io/kube-vip/kube-vip:v0.8.2') }}"
          args: ["manager"]
          env:
            # IMPORTANT: use the host's k3s kubeconfig so we don't rely on DNS "kubernetes"
            - name: KUBECONFIG
              value: /etc/rancher/k3s/k3s.yaml

            - name: cp_enable
              value: "true"
            - name: svc_enable
              value: "false"
            - name: vip_address
              value: "{{ k3s_api_vip | default('') }}"
            - name: vip_interface
              value: "{{ kubevip_interface | default(ansible_default_ipv4.interface) }}"
            - name: vip_arp
              value: "true"
            - name: vip_leaderelection
              value: "true"
            - name: port
              value: "{{ k3s_api_port | default(6443) | string }}"
          securityContext:
            privileged: true
          volumeMounts:
            - name: k3s-kubeconfig
              mountPath: /etc/rancher/k3s/k3s.yaml
              readOnly: true
      volumes:
        - name: k3s-kubeconfig
          hostPath:
            path: /etc/rancher/k3s/k3s.yaml
            type: File
      tolerations:
        - operator: Exists
      nodeSelector:
        node-role.kubernetes.io/control-plane: "true"
